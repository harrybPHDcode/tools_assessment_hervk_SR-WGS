#!/bin/bash

# job name
#SBATCH --job-name=ass_rep

# How much memory do you need **per core**?
#SBATCH --mem-per-cpu=60G

# time to run
#SBATCH --time=0-96:00

# Number of cores you need
#SBATCH --ntasks=2

# output name
#SBATCH --output=~/tempdir_long/filtered_ervcaller/new_assemble_repmask.out

# indirectory contains bam files corresponding to locations of predicted HERV-K insertions given by ERVcaller (filtered), they can be generated by simply using
# samtools view bam chr:start-stop. 
indirectory=HG002_PacBio_GRCh37

# make new directories that will store the outputs of this analysis.
directory=new_assembly_HG002
mkdir $directory
mkdir $directory/repeatmasker/

# convert all of the reads in the bam to fasta format.
for file in $indirectory/*.bam;
do
samtools bam2fq $file | seqtk seq -A > $file.fa
done

# assemble the fasta files into contiguous sequence.
for file in $indirectory/*.fa;
do
/users/k1893288/t_account/brc_scratch/t_scratch/long_read_test/wtdbg2/wtdbg2 -i $file -fo $file
/users/k1893288/t_account/brc_scratch/t_scratch/long_read_test/wtdbg2/wtpoa-cns -i $file.ctg.lay.gz -fo $file.ctg.fa
done

# loop through the contiguous sequence files and apply repeatmasker, store the output in the output directory.
for fafile in $indirectory/*.ctg.fa;
do
perl /users/k1893288/t_account/brc_scratch/t_scratch/repeatmasker/RepeatMasker/RepeatMasker $fafile -pa 2 -dir $directory/repeatmasker/
done
